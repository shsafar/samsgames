<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WordStacks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background: #ffffff;
      color: #222;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      margin-top: 12px;
      font-size: 22px;
    }

    #top-bar {
      display: flex;
      gap: 16px;
      align-items: center;
      margin: 4px 0 10px;
      font-size: 15px;
      flex-wrap: wrap;
      justify-content: center;
    }

    #top-bar .label {
      font-weight: 600;
    }

    #controls {
      margin-bottom: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: center;
    }

    #controls button {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #888;
      cursor: pointer;
      background: #f2f2f2;
      color: #222;
      font-size: 14px;
      min-width: 90px;
      -webkit-tap-highlight-color: transparent;
    }

    #controls button:active {
      background: #e0e0e0;
    }

    /* Daily mode hides New Game and Restart buttons */
    body.daily-mode #btn-new,
    body.daily-mode #btn-restart {
      display: none;
    }

    #game-area {
      width: 100%;
      max-width: 380px;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 6px;
      background: #fff;
      box-shadow: 0 0 6px rgba(0,0,0,0.06);
      height: 70vh;
      max-height: 560px;
      position: relative;
      overflow-y: auto;
      overflow-x: hidden;
      box-sizing: border-box;
      margin: 0 auto;
    }

    #board {
      position: relative;
      width: 100%;
      height: 2100px; /* enough vertical space for shapes 1â€“21 */
      padding: 0 10px;
      box-sizing: border-box;
    }

    #lines-svg {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    .node {
      position: absolute;
      width: 32px;
      height: 32px;
      margin-left: -16px;
      margin-top: -16px;
      border-radius: 50%;
      border: 2px solid #999;
      background: #fafafa;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 15px;
      box-sizing: border-box;
      z-index: 10;
      transition: border-color 0.15s, background 0.15s;
    }

    .node.fixed {
      background: #f0f0f0;
    }

    .node.shared {
      background: #ffecb3;
      border-color: #ffb300;
      color: #000;
      box-shadow: 0 0 8px rgba(255,179,0,0.7);
    }

    .node input {
      width: 100%;
      height: 100%;
      border: none;
      outline: none;
      background: transparent;
      text-align: center;
      font-weight: 600;
      font-size: 15px;
      color: #222;
    }

    .node.solved {
      border-color: #1a8b2a;
      color: #1a8b2a;
      background: #e0f7e4;
    }

    .node.wrong {
      border-color: #d32f2f;
      background: #ffebee;
    }

    .shape-label {
      position: absolute;
      width: 22px;
      height: 22px;
      margin-left: -11px;
      margin-top: -11px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 13px;
      color: #555;
      z-index: 5;
    }

    .shape-label.solved {
      color: #1a8b2a;
    }

    .path-solved {
      stroke: #1a8b2a !important;
    }

    /* CLUE BOX: fixed to the RIGHT, wraps to 2+ lines if needed */
    .clue-box {
      position: absolute;
      right: 8px;
      max-width: 52%;
      font-size: 12px;
      color: #333;
      z-index: 1;
      text-align: left;
      line-height: 1.3;
      word-wrap: break-word;
    }

    .clue-box .clue {
      font-style: italic;
    }

    #message {
      margin: 8px 8px 12px;
      font-size: 14px;
      min-height: 18px;
      text-align: center;
    }

    /* Fireworks Canvas */
    #fireworks-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
      display: none;
    }

    /* Custom Keyboard */
    #custom-keyboard {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      max-width: 100%;
      width: 100%;
      background: #d1d5db;
      padding: 4px 4px 8px 4px;
      display: none;
      z-index: 1000;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      box-sizing: border-box;
    }

    #custom-keyboard.show {
      display: block;
    }

    .keyboard-row {
      display: flex;
      justify-content: center;
      gap: 2px;
      margin-bottom: 3px;
      max-width: 100%;
      padding: 0 2px;
    }

    .keyboard-row:last-child {
      margin-bottom: 0;
    }

    .key-btn {
      background: #fff;
      border: 1px solid #999;
      border-radius: 4px;
      padding: 8px 2px;
      min-width: 24px;
      max-width: 34px;
      width: 32px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      flex-shrink: 1;
      box-sizing: border-box;
    }

    .key-btn:active {
      background: #e0e0e0;
    }

    .key-btn.wide {
      min-width: 50px;
      max-width: 64px;
      width: 60px;
      font-size: 13px;
      flex-shrink: 1;
    }

    /* Hide Next Word button */
    #btn-next {
      display: none;
    }

    /* Hide duplicate UI elements by default (Swift app uses standardized UI) */
    h1,
    #top-bar,
    #btn-new,
    #btn-restart,
    #btn-reveal,
    #btn-sound {
      display: none;
    }

    /* Show these elements only in standalone web mode (no daily-mode class) */
    body:not(.daily-mode) h1,
    body:not(.daily-mode) #top-bar,
    body:not(.daily-mode) #btn-new,
    body:not(.daily-mode) #btn-restart,
    body:not(.daily-mode) #btn-reveal,
    body:not(.daily-mode) #btn-sound {
      display: block;
    }

    body:not(.daily-mode) #controls {
      display: flex;
    }

    @media (max-width: 480px) {
      h1 { font-size: 19px; }
      #top-bar { font-size: 14px; }
      .node { width: 30px; height: 30px; margin-left: -15px; margin-top: -15px; }
      .clue-box { font-size: 11px; max-width: 56%; }
    }
  </style>
</head>
<body class="daily-mode">
  <h1>WordStacks</h1>

  <div id="top-bar">
    <span class="label">Time:</span> <span id="time-display">0</span>s
    <span class="label">Solved:</span> <span id="score-display">0</span>
  </div>

  <div id="controls">
    <button id="btn-new">New Game</button>
    <button id="btn-restart">Restart</button>
    <button id="btn-reveal">Reveal</button>
    <button id="btn-next">Next Word</button>
    <button id="btn-sound">ðŸ”Š Sound ON</button>
  </div>

  <div id="game-area">
    <div id="board">
      <svg id="lines-svg"></svg>
    </div>
  </div>

  <div id="message"></div>

  <!-- Fireworks Canvas -->
  <canvas id="fireworks-canvas"></canvas>

  <!-- Custom Keyboard -->
  <div id="custom-keyboard">
    <div class="keyboard-row">
      <div class="key-btn" data-key="Q">Q</div>
      <div class="key-btn" data-key="W">W</div>
      <div class="key-btn" data-key="E">E</div>
      <div class="key-btn" data-key="R">R</div>
      <div class="key-btn" data-key="T">T</div>
      <div class="key-btn" data-key="Y">Y</div>
      <div class="key-btn" data-key="U">U</div>
      <div class="key-btn" data-key="I">I</div>
      <div class="key-btn" data-key="O">O</div>
      <div class="key-btn" data-key="P">P</div>
    </div>
    <div class="keyboard-row">
      <div class="key-btn" data-key="A">A</div>
      <div class="key-btn" data-key="S">S</div>
      <div class="key-btn" data-key="D">D</div>
      <div class="key-btn" data-key="F">F</div>
      <div class="key-btn" data-key="G">G</div>
      <div class="key-btn" data-key="H">H</div>
      <div class="key-btn" data-key="J">J</div>
      <div class="key-btn" data-key="K">K</div>
      <div class="key-btn" data-key="L">L</div>
    </div>
    <div class="keyboard-row">
      <div class="key-btn" data-key="Z">Z</div>
      <div class="key-btn" data-key="X">X</div>
      <div class="key-btn" data-key="C">C</div>
      <div class="key-btn" data-key="V">V</div>
      <div class="key-btn" data-key="B">B</div>
      <div class="key-btn" data-key="N">N</div>
      <div class="key-btn" data-key="M">M</div>
      <div class="key-btn wide" data-key="CLEAR">Clear</div>
    </div>
  </div>

  <script>
    const MAX_WORDS = 21;

    // Seeded random number generator for daily puzzles
    let seed = Date.now();
    let savedSeed = seed; // Store the initial seed for restart functionality
    function seededRandom() {
      seed = (seed * 9301 + 49297) % 233280;
      return seed / 233280;
    }
    const ROUND_TIME = 120; // seconds

    /* Small sample WORD_BANK â€“ you can paste your 70-word lists in here */
    const WORD_BANK = {
      hex: [
        { word: "PLANET", clue: "A large body orbiting a star." },
        { word: "STREAM", clue: "Small flowing body of water." },
        { word: "BOTTLE", clue: "Container for liquids." },
        { word: "MARKET", clue: "Place for buying and selling." },
        { word: "GARDEN", clue: "Place where plants are grown." },
        { word: "POCKET", clue: "Small pouch in clothing." },
        { word: "TARGET", clue: "Something aimed at." },
        { word: "ORANGE", clue: "Citrus fruit and a color." },
        { word: "FIGURE", clue: "Shape of a person or object." },
        { word: "ABSENT", clue: "Not present." },
        { word: "GOBLET", clue: "Stemmed drinking cup." },
        { word: "SILVER", clue: "Precious gray-white metal." },
        { word: "FATHER", clue: "Male parent." },
        { word: "MOTHER", clue: "Female parent." },
        { word: "LETTER", clue: "Written message sent to someone." },
        { word: "POWDER", clue: "Dry substance of fine grains." },
        { word: "SPIDER", clue: "Eight-legged web maker." },
        { word: "JUNGLE", clue: "Dense tropical forest." },
        { word: "BRIDGE", clue: "Structure crossing water or road." },
        { word: "FLOWER", clue: "Blooming part of a plant." },
        { word: "CANDLE", clue: "Stick of wax that burns to give light." },
        { word: "ENGINE", clue: "Machine that provides power." },
        { word: "GUITAR", clue: "Stringed musical instrument." },
        { word: "LADDER", clue: "Climbing tool with rungs." },
        { word: "PUZZLE", clue: "Game that tests ingenuity." },
        { word: "ROCKET", clue: "Vehicle driven by jet propulsion." },
        { word: "TUNNEL", clue: "Passage dug through ground or rock." },
        { word: "BRICKS", clue: "Blocks used to build walls." },
        { word: "VELVET", clue: "Soft fabric with a short pile." },
        { word: "WINDOW", clue: "Opening in a wall that lets in light." },
        { word: "BUTTON", clue: "Small fastener on clothing." },
        { word: "CASTLE", clue: "Large fortified building." },
        { word: "DESERT", clue: "Dry sandy region with little rain." },
        { word: "FOREST", clue: "Large area covered with trees." },
        { word: "GLOBAL", clue: "Relating to the whole world." },
        { word: "HELMET", clue: "Protective head covering." },
        { word: "ISLAND", clue: "Land surrounded by water." },
        { word: "KERNEL", clue: "Seed or central part." },
        { word: "LISTEN", clue: "Pay attention to sound." },
        { word: "MOMENT", clue: "Brief period of time." },
        { word: "NORMAL", clue: "Usual or typical." },
        { word: "PENCIL", clue: "Writing tool with graphite." },
        { word: "RESULT", clue: "Outcome or consequence." },
        { word: "SIMPLE", clue: "Easy or uncomplicated." },
        { word: "TEMPLE", clue: "Place of worship." },
        { word: "URGENT", clue: "Requiring immediate attention." },
        { word: "VICTIM", clue: "Person harmed or injured." },
        { word: "WALLET", clue: "Small folding case for money." },
        { word: "YELLOW", clue: "Color of sunshine." },
        { word: "ZIPPER", clue: "Sliding fastener for clothes." },
        { word: "BEACON", clue: "Signal fire or guiding light." },
        { word: "CAFTAN", clue: "Long loose robe." },
        { word: "DANGER", clue: "Possibility of harm or loss." },
        { word: "EAGLES", clue: "Large birds of prey." },
        { word: "FABRIC", clue: "Cloth or material." },
        { word: "GALLON", clue: "Unit of liquid measure." },
        { word: "HAMMER", clue: "Tool for driving nails." },
        { word: "INSECT", clue: "Small six-legged creature." },
        { word: "JACKET", clue: "Short coat." },
        { word: "KITTEN", clue: "Young cat." },
        { word: "LIZARD", clue: "Small four-legged reptile." },
        { word: "MAGNET", clue: "Object that attracts iron." },
        { word: "NAPKIN", clue: "Cloth for wiping during meals." },
        { word: "OXYGEN", clue: "Gas essential for breathing." },
        { word: "PARROT", clue: "Colorful bird that can mimic speech." },
        { word: "RABBIT", clue: "Long-eared hopping mammal." },
        { word: "SALMON", clue: "Pink-fleshed fish." },
        { word: "TABLET", clue: "Flat slab or portable computer." },
        { word: "VIOLIN", clue: "Stringed instrument played with a bow." }
      ],

      pentagon: [
        { word: "STONE", clue: "Hard piece of rock." },
        { word: "LIGHT", clue: "Makes things visible." },
        { word: "RIVER", clue: "Natural flowing watercourse." },
        { word: "BOARD", clue: "Flat piece of wood." },
        { word: "FRAME", clue: "Structure that surrounds something." },
        { word: "PLANT", clue: "Living thing with leaves and roots." },
        { word: "SHEET", clue: "Large thin piece of cloth or paper." },
        { word: "TRAIN", clue: "Connected series of rail cars." },
        { word: "SOUND", clue: "What you hear." },
        { word: "WHEEL", clue: "Round thing that helps things roll." },
        { word: "SMALL", clue: "Not large." },
        { word: "CLOUD", clue: "Visible mass of water droplets in sky." },
        { word: "SHORE", clue: "Land along the edge of water." },
        { word: "FIELD", clue: "Open area of land." },
        { word: "FRUIT", clue: "Sweet edible plant part with seeds." },
        { word: "HOUSE", clue: "Building where people live." },
        { word: "WATER", clue: "Clear liquid essential for life." },
        { word: "EARTH", clue: "Planet we live on." },
        { word: "METAL", clue: "Hard, shiny material like iron or gold." },
        { word: "GLASS", clue: "Hard, clear material used in windows." },
        { word: "TABLE", clue: "Piece of furniture with a flat top." },
        { word: "CHAIR", clue: "Seat for one person." },
        { word: "BREAD", clue: "Baked food made from flour." },
        { word: "CHEST", clue: "Box with a lid for storage." },
        { word: "HEART", clue: "Organ that pumps blood." },
        { word: "SMILE", clue: "Happy expression on the face." },
        { word: "DREAM", clue: "Images or ideas during sleep." },
        { word: "NIGHT", clue: "Time when it is dark." },
        { word: "ARROW", clue: "Thin pointed missile shot from a bow." },
        { word: "CROWN", clue: "Decorative headpiece worn by royalty." },
        { word: "ANGLE", clue: "Space between two intersecting lines." },
        { word: "BEACH", clue: "Sandy shore by the ocean." },
        { word: "CABLE", clue: "Thick rope or wire." },
        { word: "DANCE", clue: "Move rhythmically to music." },
        { word: "EMAIL", clue: "Electronic message sent online." },
        { word: "FEAST", clue: "Large meal with many dishes." },
        { word: "GRAIN", clue: "Small hard seed of a cereal plant." },
        { word: "HONEY", clue: "Sweet substance made by bees." },
        { word: "IMAGE", clue: "Picture or visual representation." },
        { word: "JOINT", clue: "Place where two things meet." },
        { word: "KNOCK", clue: "Strike a surface to make a sound." },
        { word: "LEMON", clue: "Yellow citrus fruit." },
        { word: "MAGIC", clue: "Supernatural power or illusion." },
        { word: "NORTH", clue: "Direction toward the top of a map." },
        { word: "OCEAN", clue: "Very large body of salt water." },
        { word: "PEACE", clue: "Freedom from war or conflict." },
        { word: "QUEEN", clue: "Female monarch." },
        { word: "RANCH", clue: "Large farm for raising animals." },
        { word: "SOUTH", clue: "Direction opposite of north." },
        { word: "TOWER", clue: "Tall narrow building." },
        { word: "UNITY", clue: "State of being united or joined." },
        { word: "VALUE", clue: "Worth or importance." },
        { word: "WATCH", clue: "Timepiece worn on wrist." },
        { word: "YOUTH", clue: "Period of being young." },
        { word: "BRAVE", clue: "Courageous and fearless." },
        { word: "STORM", clue: "Violent weather with wind and rain." },
        { word: "CLIMB", clue: "Go up using hands and feet." },
        { word: "FLUTE", clue: "Wind instrument played sideways." },
        { word: "GRAPE", clue: "Small round fruit growing in clusters." },
        { word: "LEVEL", clue: "Flat or even surface." },
        { word: "LUCKY", clue: "Having good fortune." },
        { word: "MELON", clue: "Large sweet fruit with thick skin." },
        { word: "ORBIT", clue: "Curved path of object around a planet." },
        { word: "PIANO", clue: "Large keyboard instrument." },
        { word: "RIDER", clue: "Person who rides a horse or vehicle." },
        { word: "SHARK", clue: "Large predatory fish." },
        { word: "SPOON", clue: "Utensil with a bowl-shaped end." },
        { word: "TRUNK", clue: "Main stem of a tree." },
        { word: "VOCAL", clue: "Relating to the voice." }
      ],

      square: [
        { word: "MOON", clue: "Earth's natural satellite." },
        { word: "FISH", clue: "Animal that lives in water." },
        { word: "TREE", clue: "Tall plant with a trunk." },
        { word: "WIND", clue: "Air in motion." },
        { word: "STAR", clue: "Luminous body in space." },
        { word: "BIRD", clue: "Animal with feathers and wings." },
        { word: "ROAD", clue: "Path for vehicles." },
        { word: "BOOK", clue: "Printed pages bound together." },
        { word: "HAND", clue: "End of the arm with fingers." },
        { word: "RING", clue: "Circular band worn on a finger." },
        { word: "SHIP", clue: "Large boat for traveling by sea." },
        { word: "CORN", clue: "Yellow grain eaten as food." },
        { word: "LAMP", clue: "Object that gives light indoors." },
        { word: "TIME", clue: "Measure of when things happen." },
        { word: "LEAF", clue: "Thin green part of a plant." },
        { word: "BELL", clue: "Hollow object that rings when struck." },
        { word: "CHEF", clue: "Professional cook." },
        { word: "FORK", clue: "Utensil with prongs for eating." },
        { word: "GIFT", clue: "Something given to someone." },
        { word: "GOAL", clue: "Target or objective." },
        { word: "HILL", clue: "Small raised area of land." },
        { word: "KITE", clue: "Toy that flies on a string." },
        { word: "LAKE", clue: "Large inland body of water." },
        { word: "PARK", clue: "Public green space for recreation." },
        { word: "RICE", clue: "Small white grain eaten as food." },
        { word: "SALT", clue: "White crystals used to season food." },
        { word: "TOWN", clue: "Place where many people live." },
        { word: "WAVE", clue: "Moving ridge on the surface of water." },
        { word: "WOOD", clue: "Material that comes from trees." },
        { word: "ROOM", clue: "Part of a building with walls and a door." },
        { word: "BLUE", clue: "Color of the sky." },
        { word: "COIN", clue: "Piece of metal money." },
        { word: "DEER", clue: "Forest animal with antlers." },
        { word: "EDGE", clue: "Outer boundary or limit." },
        { word: "FACE", clue: "Front of the head." },
        { word: "GOLD", clue: "Precious yellow metal." },
        { word: "HOPE", clue: "Feeling of expectation." },
        { word: "IRON", clue: "Strong gray metal." },
        { word: "JOKE", clue: "Something said to cause laughter." },
        { word: "KING", clue: "Male monarch." },
        { word: "LION", clue: "Large wild cat with a mane." },
        { word: "MAIL", clue: "Letters and packages sent by post." },
        { word: "NOSE", clue: "Organ used for smelling." },
        { word: "PAIR", clue: "Two identical things." },
        { word: "ROSE", clue: "Flower with thorns." },
        { word: "SONG", clue: "Musical composition with words." },
        { word: "TASK", clue: "Piece of work to be done." },
        { word: "USER", clue: "Person who uses something." },
        { word: "VICE", clue: "Bad habit or behavior." },
        { word: "WOLF", clue: "Wild dog-like predator." },
        { word: "YARD", clue: "Unit of length or outdoor area." },
        { word: "ZERO", clue: "The number before one." },
        { word: "BEAR", clue: "Large furry mammal." },
        { word: "CAVE", clue: "Natural underground hollow." },
        { word: "DRUM", clue: "Percussion instrument." },
        { word: "FAME", clue: "State of being well known." },
        { word: "GATE", clue: "Movable barrier in a fence." },
        { word: "HERO", clue: "Person admired for courage." },
        { word: "IDEA", clue: "Thought or suggestion." },
        { word: "JURY", clue: "Group deciding a court case." },
        { word: "KNEE", clue: "Joint in the middle of the leg." },
        { word: "LIFE", clue: "State of being alive." },
        { word: "MILE", clue: "Unit of distance." },
        { word: "OVEN", clue: "Enclosed space for baking." },
        { word: "POEM", clue: "Literary work in verse." },
        { word: "QUIZ", clue: "Short test of knowledge." },
        { word: "ROPE", clue: "Thick cord of twisted strands." },
        { word: "TENT", clue: "Portable shelter made of fabric." },
        { word: "VOTE", clue: "Express choice in an election." }
      ],

      triangle: [
        { word: "CAT", clue: "Common house pet." },
        { word: "SUN", clue: "Star at the center of our system." },
        { word: "KEY", clue: "Used to open a lock." },
        { word: "ICE", clue: "Frozen water." },
        { word: "MAP", clue: "Diagram of an area." },
        { word: "DOG", clue: "Loyal four-legged pet." },
        { word: "BUS", clue: "Large road vehicle for passengers." },
        { word: "CAR", clue: "Four-wheeled vehicle." },
        { word: "BED", clue: "Furniture used for sleeping." },
        { word: "BOX", clue: "Container with flat sides." },
        { word: "HAT", clue: "Clothing worn on the head." },
        { word: "PEN", clue: "Tool for writing with ink." },
        { word: "JAR", clue: "Glass container with a lid." },
        { word: "FOG", clue: "Low cloud that reduces visibility." },
        { word: "ANT", clue: "Small insect that lives in colonies." },
        { word: "ROW", clue: "Line of things or people." },
        { word: "BEE", clue: "Insect that makes honey." },
        { word: "CAP", clue: "Soft hat with a visor." },
        { word: "GAS", clue: "Substance like air that is not solid or liquid." },
        { word: "INK", clue: "Colored liquid used for writing." },
        { word: "LID", clue: "Cover for a container." },
        { word: "MUD", clue: "Wet, soft earth." },
        { word: "NAP", clue: "Short period of sleep." },
        { word: "OAK", clue: "Type of tree with strong wood." },
        { word: "PAN", clue: "Shallow cooking vessel." },
        { word: "RIM", clue: "Outer edge of something round." },
        { word: "SAW", clue: "Tool with teeth for cutting wood." },
        { word: "ZIP", clue: "Fastener made of two rows of teeth." },
        { word: "EGG", clue: "Hard-shelled food from birds." },
        { word: "JET", clue: "Fast airplane." },
        { word: "ART", clue: "Creative work or skill." },
        { word: "BAG", clue: "Container made of flexible material." },
        { word: "CUP", clue: "Small container for drinking." },
        { word: "DIG", clue: "Break up and move earth." },
        { word: "EYE", clue: "Organ used for seeing." },
        { word: "FAN", clue: "Device that moves air." },
        { word: "GYM", clue: "Place for physical exercise." },
        { word: "HIT", clue: "Strike forcefully." },
        { word: "JOY", clue: "Feeling of great happiness." },
        { word: "LAW", clue: "System of rules." },
        { word: "MIX", clue: "Combine different things." },
        { word: "NET", clue: "Mesh material for catching." },
        { word: "OWL", clue: "Nocturnal bird of prey." },
        { word: "PET", clue: "Domestic animal kept for companionship." },
        { word: "RUN", clue: "Move quickly on foot." },
        { word: "SKY", clue: "Space above the earth." },
        { word: "TEN", clue: "Number after nine." },
        { word: "VAN", clue: "Large vehicle for carrying goods." },
        { word: "WAR", clue: "Armed conflict between nations." },
        { word: "YES", clue: "Affirmative answer." },
        { word: "ZOO", clue: "Place where wild animals are kept." },
        { word: "BAT", clue: "Flying mammal or sports equipment." },
        { word: "COW", clue: "Large farm animal that gives milk." },
        { word: "DAY", clue: "Period of 24 hours." },
        { word: "ELF", clue: "Mythical small magical being." },
        { word: "FLY", clue: "Move through air with wings." },
        { word: "GUM", clue: "Sticky substance or candy." },
        { word: "HUG", clue: "Embrace with arms." },
        { word: "ILL", clue: "Not feeling well or sick." },
        { word: "JAM", clue: "Sweet fruit preserve." },
        { word: "KIT", clue: "Set of equipment or tools." },
        { word: "LOG", clue: "Thick piece of wood from a tree." },
        { word: "MAT", clue: "Piece of material for floor or table." },
        { word: "NUT", clue: "Hard-shelled dry fruit." },
        { word: "ORE", clue: "Rock containing valuable metal." },
        { word: "POD", clue: "Seed case of certain plants." },
        { word: "RAT", clue: "Long-tailed rodent." },
        { word: "SIT", clue: "Rest on a seat." },
        { word: "TOY", clue: "Object for children to play with." }
      ]
    };

    const SHAPE_TYPES = ["hex", "pentagon", "square", "triangle"];

    const board = document.getElementById("board");
    const svg = document.getElementById("lines-svg");
    const gameArea = document.getElementById("game-area");
    const msgEl = document.getElementById("message");

    let shapes = [];
    let usedWords = new Set();
    let timeElapsed = 0;
    let timerId = null;
    let score = 0;
    let dailyMode = document.body.classList.contains('daily-mode'); // Check if body has daily-mode class
    let soundEnabled = true;
    let currentInput = null;
    const keyboard = document.getElementById("custom-keyboard");

    function randomChoice(arr) {
      return arr[Math.floor(seededRandom() * arr.length)];
    }

    function getRadius() {
      return 46;
    }

    function polygonBottomFirst(count, cx, cy, r) {
      const pts = [];
      const startAngle = Math.PI / 2; // bottom point first
      const step = (2 * Math.PI) / count;
      for (let i = 0; i < count; i++) {
        const angle = startAngle + step * i;
        pts.push({ x: cx + r * Math.cos(angle), y: cy + r * Math.sin(angle) });
      }
      return pts;
    }

    function getShapeSize(type) {
      if (type === "triangle") return 3;
      if (type === "square") return 4;
      if (type === "pentagon") return 5;
      return 6;
    }

    function findWordsWithLetter(shapeType, letter) {
      const up = letter.toUpperCase();
      return WORD_BANK[shapeType].filter(
        e => e.word.toUpperCase().includes(up) &&
             !usedWords.has(shapeType + ":" + e.word.toUpperCase())
      );
    }

    function pickAnyUnused(shapeType) {
      const pool = WORD_BANK[shapeType].filter(
        e => !usedWords.has(shapeType + ":" + e.word.toUpperCase())
      );
      if (pool.length === 0) return randomChoice(WORD_BANK[shapeType]);
      return randomChoice(pool);
    }

    function computeHiddenIndices(length, sharedIndex) {
      if (length <= 2) return new Set([0]);
      const all = [];
      for (let i = 0; i < length; i++) all.push(i);
      const pool = all.filter(i => i !== sharedIndex);
      const maxHide = Math.max(1, Math.floor(length / 2));
      const hideCount = Math.min(pool.length, Math.floor(seededRandom() * maxHide) + 1);
      const hidden = new Set();
      const p = [...pool];
      while (hidden.size < hideCount && p.length) {
        const idx = Math.floor(seededRandom() * p.length);
        hidden.add(p.splice(idx, 1)[0]);
      }
      return hidden;
    }

    function setMessage(text) {
      msgEl.textContent = text || "";
    }

    function startTimer() {
      const tEl = document.getElementById("time-display");
      if (timerId) clearInterval(timerId);
      timeElapsed = 0;
      tEl.textContent = timeElapsed;
      updateGameStats();
      timerId = setInterval(() => {
        timeElapsed++;
        tEl.textContent = timeElapsed;
        updateGameStats();
      }, 1000);
    }

    function stopTimer() {
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
      }
      return timeElapsed;
    }

    function drawShape(shape) {
      const pts = shape.nodes.map(n => [n.x, n.y]);
      if (pts.length > 1) {
        let d = "";
        for (let i = 0; i < pts.length; i++) {
          const [x, y] = pts[i];
          d += (i === 0 ? "M" : "L") + x + " " + y + " ";
        }
        d += "Z";
        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        path.setAttribute("d", d);
        path.setAttribute("stroke", "#cccccc");
        path.setAttribute("stroke-width", "2");
        path.setAttribute("fill", "none");
        svg.appendChild(path);
        shape.pathEl = path;
      }

      const lbl = document.createElement("div");
      lbl.className = "shape-label";
      lbl.textContent = shape.index;
      lbl.style.left = shape.center.x + "px";
      lbl.style.top = shape.center.y + "px";
      board.appendChild(lbl);
      shape.labelEl = lbl;

      const clueBox = document.createElement("div");
      clueBox.className = "clue-box";
      clueBox.style.top = (shape.center.y - 10) + "px"; // vertical aligned to center
      const clueDiv = document.createElement("div");
      clueDiv.className = "clue";
      clueDiv.textContent = shape.clue;
      clueBox.appendChild(clueDiv);
      board.appendChild(clueBox);
      shape.clueEl = clueBox;

      shape.nodes.forEach(node => {
        const div = document.createElement("div");
        div.className = "node";
        div.style.left = node.x + "px";
        div.style.top = node.y + "px";

        if (node.shared) div.classList.add("shared");

        if (node.fixed) {
          div.classList.add("fixed");
          div.textContent = node.letter;
        } else {
          const input = document.createElement("input");
          input.type = "text";
          input.maxLength = 1;
          input.readOnly = true; // Prevent iOS keyboard
          input.dataset.answer = node.letter;

          // Show custom keyboard on tap
          input.addEventListener("click", (e) => {
            e.preventDefault();
            currentInput = input;
            keyboard.classList.add("show");
            // Focus styling
            document.querySelectorAll(".node input").forEach(inp => {
              inp.parentElement.style.boxShadow = "";
            });
            input.parentElement.style.boxShadow = "0 0 0 3px #4a90e2";
          });

          // Manual input handling for testing (optional)
          input.addEventListener("input", () => {
            const val = input.value.toUpperCase().slice(0, 1);
            input.value = val;
            const expected = input.dataset.answer;
            const nodeDiv = input.parentElement;
            if (val && val !== expected) {
              nodeDiv.classList.add("wrong");
            } else {
              nodeDiv.classList.remove("wrong");
            }
            checkShapeSolved(shape);
          });

          div.appendChild(input);
          node.inputEl = input;
        }

        board.appendChild(div);
        node.el = div;
      });

      setTimeout(() => {
        const target = shape.center.y - gameArea.clientHeight / 2;
        gameArea.scrollTop = Math.max(0, target);
      }, 0);
    }

    function markSharedNode(shape, nodeIndex) {
      if (!shape) return;
      if (nodeIndex < 0 || nodeIndex >= shape.nodes.length) return;
      const node = shape.nodes[nodeIndex];
      node.shared = true;
      if (node.el) node.el.classList.add("shared");
    }

    function maybeAdvanceOrFinish(solvedShape) {
      if (score >= MAX_WORDS) {
        const finalTime = stopTimer();
        const minutes = Math.floor(finalTime / 60);
        const seconds = finalTime % 60;
        const timeStr = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
        keyboard.classList.remove("show");

        // Show fireworks animation first
        showFireworks();

        // Victory fanfare
        if (soundEnabled) {
          setTimeout(() => playSound(523.25, 0.15), 0);    // C5
          setTimeout(() => playSound(659.25, 0.15), 150);  // E5
          setTimeout(() => playSound(783.99, 0.3), 300);   // G5
        }

        // Show completion message after 2 seconds (after fireworks)
        setTimeout(() => {
          setMessage(`Congratulations! You solved all ${MAX_WORDS} words in ${timeStr}!`);
          if (dailyMode && window.webkit && window.webkit.messageHandlers.gameCompleted) {
            window.webkit.messageHandlers.gameCompleted.postMessage({ score: score, maxScore: MAX_WORDS });
          }
        }, 2000);

        return;
      }

      if (!solvedShape) return;

      const topIndex = Math.max(...shapes.map(s => s.index));
      if (solvedShape.index === topIndex) {
        addShape(solvedShape);  // auto-next
      }
    }

    function checkShapeSolved(shape) {
      if (shape.solved) return;
      let ok = true;
      for (const node of shape.nodes) {
        if (!node.fixed) {
          if (!node.inputEl || node.inputEl.value.toUpperCase() !== node.letter) {
            ok = false;
            break;
          }
        }
      }
      if (!ok) return;

      shape.solved = true;
      shape.nodes.forEach(n => {
        if (n.el) {
          n.el.classList.remove("wrong");
          n.el.classList.add("solved");
        }
      });
      if (shape.pathEl) shape.pathEl.classList.add("path-solved");
      if (shape.labelEl) shape.labelEl.classList.add("solved");

      score++;
      document.getElementById("score-display").textContent = score;
      setMessage("Shape " + shape.index + " solved.");
      playSound(523.25, 0.2); // C5 note for success
      maybeAdvanceOrFinish(shape);
    }

    function addShape(prevShape) {
      if (shapes.length >= MAX_WORDS) {
        return;
      }

      const index = shapes.length + 1;
      const boardRect = board.getBoundingClientRect();
      const width = boardRect.width;

      let shapeType, entry, word, clue;
      let center, radius;
      let sharedLetter = null;

      if (!prevShape) {
        // FIRST SHAPE â€“ always hex
        shapeType = "hex";
        entry = pickAnyUnused(shapeType);
        word = entry.word.toUpperCase();
        clue = entry.clue;
        radius = getRadius();
        center = { x: width * 0.35, y: board.clientHeight - radius - 40 };

        const count = getShapeSize(shapeType);
        const base = polygonBottomFirst(count, center.x, center.y, radius);
        const sharedIndex = 0;
        const hidden = computeHiddenIndices(word.length, sharedIndex);
        const nodes = [];
        for (let i = 0; i < word.length; i++) {
          const polyIndex = (i - sharedIndex + count) % count;
          const pos = base[polyIndex];
          const ch = word[i];
          const fixed = !hidden.has(i);
          nodes.push({
            x: pos.x,
            y: pos.y,
            letter: ch,
            fixed,
            shared: false,
            el: null,
            inputEl: null
          });
        }

        usedWords.add(shapeType + ":" + word);

        const shape = {
          index,
          type: shapeType,
          word,
          clue,
          center,
          radius,
          nodes,
          solved: false,
          pathEl: null,
          labelEl: null,
          clueEl: null
        };

        // clamp first shape horizontally
        const boardWidth = board.clientWidth;
        const margin = 28;
        const minCX = shape.radius + margin;
        const maxCX = boardWidth - shape.radius - margin;
        let dx = 0;
        if (shape.center.x < minCX) dx = minCX - shape.center.x;
        else if (shape.center.x > maxCX) dx = maxCX - shape.center.x;
        if (dx !== 0) {
          shape.center.x += dx;
          shape.nodes.forEach(n => { n.x += dx; });
        }

        shapes.push(shape);
        drawShape(shape);
        return;
      }

      // SUBSEQUENT SHAPES
      let topNodeIndex = 0;
      let minY = Infinity;
      prevShape.nodes.forEach((n, i) => {
        if (n.y < minY) {
          minY = n.y;
          topNodeIndex = i;
        }
      });
      const S = prevShape.nodes[topNodeIndex];
      sharedLetter = S.letter;

      let chosen = null;
      for (let attempt = 0; attempt < 20 && !chosen; attempt++) {
        const candidateType = randomChoice(SHAPE_TYPES);
        const candidates = findWordsWithLetter(candidateType, sharedLetter);
        if (candidates.length) {
          chosen = { type: candidateType, entry: randomChoice(candidates) };
        }
      }
      if (!chosen) {
        const fallbackType = randomChoice(SHAPE_TYPES);
        chosen = { type: fallbackType, entry: pickAnyUnused(fallbackType) };
      }

      shapeType = chosen.type;
      entry = chosen.entry;
      word = entry.word.toUpperCase();
      clue = entry.clue;
      radius = getRadius();

      const indices = [];
      for (let i = 0; i < word.length; i++) {
        if (word[i] === sharedLetter) indices.push(i);
      }
      const newSharedIndex = indices.length ? randomChoice(indices) : 0;

      const jitter = (seededRandom() - 0.5) * radius * 0.6;
      center = { x: S.x + jitter, y: S.y - radius };

      markSharedNode(prevShape, topNodeIndex);

      const count = getShapeSize(shapeType);
      const base = polygonBottomFirst(count, center.x, center.y, radius);
      const hidden = computeHiddenIndices(word.length, newSharedIndex);
      const nodes = [];
      for (let i = 0; i < word.length; i++) {
        const polyIndex = (i - newSharedIndex + count) % count;
        const pos = base[polyIndex];
        const ch = word[i];
        const isShared = (i === newSharedIndex);
        const fixed = !hidden.has(i);
        nodes.push({
          x: pos.x,
          y: pos.y,
          letter: ch,
          fixed,
          shared: isShared,
          el: null,
          inputEl: null
        });
      }

      usedWords.add(shapeType + ":" + word);

      const shape = {
        index,
        type: shapeType,
        word,
        clue,
        center,
        radius,
        nodes,
        solved: false,
        pathEl: null,
        labelEl: null,
        clueEl: null
      };

      // clamp subsequent shapes horizontally
      const boardWidth2 = board.clientWidth;
      const margin2 = 28;
      const minCX2 = shape.radius + margin2;
      const maxCX2 = boardWidth2 - shape.radius - margin2;
      let dx2 = 0;
      if (shape.center.x < minCX2) dx2 = minCX2 - shape.center.x;
      else if (shape.center.x > maxCX2) dx2 = maxCX2 - shape.center.x;
      if (dx2 !== 0) {
        shape.center.x += dx2;
        shape.nodes.forEach(n => { n.x += dx2; });
      }

      shapes.push(shape);
      drawShape(shape);
    }

    function clearBoard() {
      shapes = [];
      usedWords.clear();
      while (board.firstChild) board.removeChild(board.firstChild);
      board.appendChild(svg);
      while (svg.firstChild) svg.removeChild(svg.firstChild);
    }

    function newGame() {
      clearBoard();
      score = 0;
      document.getElementById("score-display").textContent = score;
      setMessage("");

      // In daily mode, restore the saved seed to get same puzzle
      if (dailyMode) {
        seed = savedSeed;
      }

      addShape(null);
      startTimer();
      setTimeout(() => {
        gameArea.scrollTop = gameArea.scrollHeight;
      }, 0);
    }

    function restartGame() {
      // Restore the original seed before restarting
      if (dailyMode) {
        seed = savedSeed;
      }
      newGame();
      setMessage("Restarted.");
    }

    function revealTop() {
      if (!shapes.length) return;
      const topIndex = Math.max(...shapes.map(s => s.index));
      const top = shapes.find(s => s.index === topIndex);
      if (!top) return;
      top.nodes.forEach(node => {
        if (!node.fixed && node.inputEl) {
          node.inputEl.value = node.letter;
          if (node.el) node.el.classList.remove("wrong");
        }
      });
      checkShapeSolved(top);
    }

    function nextWordManual() {
      if (shapes.length >= MAX_WORDS) {
        setMessage("Maximum of " + MAX_WORDS + " words reached.");
        return;
      }
      if (!shapes.length) {
        addShape(null);
        return;
      }
      const topIndex = Math.max(...shapes.map(s => s.index));
      const top = shapes.find(s => s.index === topIndex);
      if (top && !top.solved) {
        alert("Solve the current word before moving to the next one.");
        return;
      }
      addShape(top);
    }

    function toggleSound() {
      soundEnabled = !soundEnabled;
      const btn = document.getElementById("btn-sound");
      if (soundEnabled) {
        btn.textContent = "ðŸ”Š Sound ON";
      } else {
        btn.textContent = "ðŸ”‡ Sound OFF";
      }
    }

    function playSound(frequency, duration) {
      if (!soundEnabled) return;

      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.value = frequency;
        oscillator.type = 'sine';

        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + duration);
      } catch (e) {
        // Audio not supported, silently fail
      }
    }

    // Fireworks animation
    function showFireworks() {
      const canvas = document.getElementById("fireworks-canvas");
      if (!canvas) return;

      canvas.style.display = "block";
      const ctx = canvas.getContext("2d");
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      const particles = [];
      const colors = ["#FF1461", "#18FF92", "#5A87FF", "#FBF38C", "#FF6B6B", "#4ECDC4"];

      class Particle {
        constructor(x, y, color) {
          this.x = x;
          this.y = y;
          this.color = color;
          this.velocity = {
            x: (Math.random() - 0.5) * 8,
            y: (Math.random() - 0.5) * 8 - 2
          };
          this.alpha = 1;
          this.decay = Math.random() * 0.015 + 0.015;
          this.size = Math.random() * 3 + 2;
        }

        update() {
          this.velocity.y += 0.2; // gravity
          this.x += this.velocity.x;
          this.y += this.velocity.y;
          this.alpha -= this.decay;
        }

        draw() {
          ctx.save();
          ctx.globalAlpha = this.alpha;
          ctx.fillStyle = this.color;
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();
        }
      }

      function createFirework(x, y) {
        const color = colors[Math.floor(Math.random() * colors.length)];
        const particleCount = 30 + Math.random() * 20;

        for (let i = 0; i < particleCount; i++) {
          particles.push(new Particle(x, y, color));
        }
      }

      let frameCount = 0;
      let animationId;

      function animate() {
        ctx.fillStyle = "rgba(0, 0, 0, 0.1)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Create new fireworks at the top
        if (frameCount % 15 === 0 && frameCount < 120) {
          const x = Math.random() * canvas.width;
          const y = canvas.height * 0.2 + Math.random() * canvas.height * 0.1;
          createFirework(x, y);
        }

        // Update and draw particles
        for (let i = particles.length - 1; i >= 0; i--) {
          particles[i].update();
          particles[i].draw();

          if (particles[i].alpha <= 0) {
            particles.splice(i, 1);
          }
        }

        frameCount++;

        // Stop after 2 seconds (120 frames at 60fps)
        if (frameCount < 120) {
          animationId = requestAnimationFrame(animate);
        } else {
          // Fade out remaining particles
          if (particles.length > 0) {
            animationId = requestAnimationFrame(animate);
          } else {
            canvas.style.display = "none";
            ctx.clearRect(0, 0, canvas.width, canvas.height);
          }
        }
      }

      animate();
    }

    // Custom keyboard handlers
    document.querySelectorAll(".key-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        if (!currentInput) return;

        const key = btn.dataset.key;
        if (key === "CLEAR") {
          currentInput.value = "";
          currentInput.parentElement.classList.remove("wrong");
        } else {
          currentInput.value = key;
          const expected = currentInput.dataset.answer;
          const nodeDiv = currentInput.parentElement;
          if (key !== expected) {
            nodeDiv.classList.add("wrong");
          } else {
            nodeDiv.classList.remove("wrong");
          }
          // Find the shape this input belongs to and check if solved
          shapes.forEach(shape => {
            shape.nodes.forEach(node => {
              if (node.inputEl === currentInput) {
                checkShapeSolved(shape);
              }
            });
          });
        }
      });
    });

    // Close keyboard when tapping outside
    document.addEventListener("click", (e) => {
      if (!e.target.closest(".node input") && !e.target.closest("#custom-keyboard")) {
        keyboard.classList.remove("show");
        document.querySelectorAll(".node input").forEach(inp => {
          inp.parentElement.style.boxShadow = "";
        });
        currentInput = null;
      }
    });

    document.getElementById("btn-new").addEventListener("click", newGame);
    document.getElementById("btn-restart").addEventListener("click", restartGame);
    document.getElementById("btn-reveal").addEventListener("click", revealTop);
    document.getElementById("btn-next").addEventListener("click", nextWordManual);
    document.getElementById("btn-sound").addEventListener("click", toggleSound);

    // Start immediately in non-daily mode
    if (!dailyMode) {
    newGame();
    }

    // Swift integration functions
    function setSeed(newSeed) {
      seed = newSeed;
      savedSeed = newSeed; // Save the seed for restart functionality
    }

    function enableDailyMode() {
      dailyMode = true;
      document.body.classList.add('daily-mode');
    }

    function startGame() {
      newGame();
    }

    // Helper functions for Swift integration
    function resetGame() {
      restartGame();
    }

    function revealHint() {
      revealTop();
    }

    // Sound control for Swift
    function setSoundEnabled(enabled) {
      soundEnabled = enabled;
    }

    // Send game stats to Swift
    function updateGameStats() {
      if (!window.webkit || !window.webkit.messageHandlers || !window.webkit.messageHandlers.gameStats) {
        return;  // Not in Swift webview
      }

      const solvedCount = shapes.filter(s => s.solved).length;
      const minutes = Math.floor(timeElapsed / 60);
      const seconds = timeElapsed % 60;
      const timeStr = minutes + ":" + (seconds < 10 ? "0" : "") + seconds;

      window.webkit.messageHandlers.gameStats.postMessage({
        time: timeStr,
        solved: solvedCount
      });
    }

    // Expose to Swift
    window.setSeed = setSeed;
    window.enableDailyMode = enableDailyMode;
    window.startGame = startGame;
    window.resetGame = resetGame;
    window.revealHint = revealHint;
  </script>
</body>
</html>
